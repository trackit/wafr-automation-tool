AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: State Machine

Parameters:
  Owner:
    Type: String
  Project:
    Type: String
  ParentStackName:
    Type: String
  Debug:
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
  SharedLibsLayer:
    Type: String
  DynamoDBArn:
    Type: String
  S3BucketName:
    Type: String
  ECSCluster:
    Type: String
  ECSExecutionRole:
    Type: String
  ProwlerTaskDefinition:
    Type: String
  ProwlerTaskRole:
    Type: String
  CloudCustodianTaskDefinition:
    Type: String
  CloudCustodianTaskRole:
    Type: String
  CloudSploitTaskDefinition:
    Type: String
  CloudSploitTaskRole:
    Type: String
  Subnet:
    Type: String
  SecurityGroup:
    Type: String
  LogRetentionInDays:
    Type: Number
    Default: 14

Globals:
  Function:
    Timeout: 30
    MemorySize: 128
    Runtime: python3.12
    Layers:
      - !Ref SharedLibsLayer
    Environment:
      Variables:
        DEBUG: !Ref Debug
        REGION: !Ref AWS::Region
        S3_BUCKET: !Ref S3BucketName
        DDB_TABLE: !Ref DynamoDBArn

Resources:
  PreparePromptsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${PreparePromptsFunction}'
      RetentionInDays: !Ref LogRetentionInDays
  PreparePromptsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: main.lambda_handler
      Runtime: python3.12
      CodeUri: ../backend/src/state_machine/prepare_prompts/app
      Tags:
        Owner: !Ref Owner
        Project: !Ref Project
        Name: PreparePromptsFunction
      Timeout: 600
      MemorySize: 1024
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3:::${S3BucketName}/*'
            - Effect: Allow
              Action:
                - s3:ListBucket
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3:::${S3BucketName}'
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
                - dynamodb:PutItem
              Resource:
                - !Ref DynamoDBArn
            - Effect: Allow
              Action:
                - bedrock:GetPrompt
                - bedrock:ListPrompts
              Resource:
                - !GetAtt BedrockPrompt.Arn
  InvokeLLMLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${InvokeLLMFunction}'
      RetentionInDays: !Ref LogRetentionInDays
  InvokeLLMFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: main.lambda_handler
      Runtime: python3.12
      CodeUri: ../backend/src/state_machine/invoke_llm/app
      Tags:
        Owner: !Ref Owner
        Project: !Ref Project
        Name: InvokeLLMFunction
      Timeout: 900
      MemorySize: 128
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3:::${S3BucketName}/*'
            - Effect: Allow
              Action:
                - s3:ListBucket
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3:::${S3BucketName}'
            - Effect: Allow
              Action:
                - bedrock:InvokeModelWithResponseStream
              Resource:
                - 'arn:aws:bedrock:*:*:inference-profile/*'
                - 'arn:aws:bedrock:*::foundation-model/*'
            - Effect: Allow
              Action:
                - bedrock:RenderPrompt
              Resource:
                - !GetAtt BedrockPrompt.Arn
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
                - dynamodb:PutItem
              Resource:
                - !Ref DynamoDBArn
      Environment:
        Variables:
          AI_MODEL: claude-3-7-sonnet
  CleanupLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${CleanupFunction}'
      RetentionInDays: !Ref LogRetentionInDays
  CleanupFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: main.lambda_handler
      Runtime: python3.12
      CodeUri: ../backend/src/state_machine/cleanup/app
      Tags:
        Owner: !Ref Owner
        Project: !Ref Project
        Name: CleanupFunction
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:BatchWriteItem
                - dynamodb:GetItem
              Resource:
                - !Ref DynamoDBArn
            - Effect: Allow
              Action:
                - s3:DeleteObject
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3:::${S3BucketName}/*'
            - Effect: Allow
              Action:
                - s3:ListBucket
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3:::${S3BucketName}'
  PrepareCustodianLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${PrepareCustodianFunction}'
      RetentionInDays: !Ref LogRetentionInDays
  PrepareCustodianFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: main.lambda_handler
      Runtime: python3.12
      CodeUri: ../backend/src/state_machine/prepare_custodian/app
      Tags:
        Owner: !Ref Owner
        Project: !Ref Project
        Name: PrepareCustodianFunction
      Timeout: 600
      MemorySize: 128
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
              Resource:
                - !Sub 'arn:${AWS::Partition}:s3:::${S3BucketName}/*'
  ComputeGraphDataLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ComputeGraphDataFunction}'
      RetentionInDays: !Ref LogRetentionInDays
  ComputeGraphDataFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: handler.main
      Runtime: nodejs22.x
      CodeUri: ../apps/backend/src/handlers/stateMachine/computeGraphData
      Timeout: 600
      Tags:
        Owner: !Ref Owner
        Project: !Ref Project
        Name: ComputeGraphDataFunction
      MemorySize: 128
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource:
                - !Ref DynamoDBArn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Format: cjs
        Target: 'es2020'
        Minify: false
        Sourcemap: true
        EntryPoints:
          - handler.ts
  BedrockPrompt:
    Type: 'AWS::Bedrock::Prompt'
    Properties:
      Name: !Sub ${ParentStackName}-prompt
      Description: 'The prompt used to generate responses.'
      DefaultVariant: 'prompt'
      Variants:
        - Name: 'prompt'
          TemplateType: 'TEXT'
          ModelId: 'us.anthropic.claude-3-7-sonnet-20250219-v1:0'
          TemplateConfiguration:
            Text:
              InputVariables:
                - Name: scanning_tool_title
                - Name: question_set_data
                - Name: scanning_tool_data
              Text: |
                Context:
                - We have a set of {{scanning_tool_title}} findings from our AWS environment.
                - Each finding must be assessed and mapped to a specific WAFR best practice based on our predefined pillars and questions.
                Objective:
                - Transform the scanning tool findings into a JSON mapping where each mapping associates a contiguous range of findings with a unique WAFR best practice ID.
                Output Format:
                - The final output must be a minified JSON array containing objects with the following structure:
                  [{"id": integer, "start": integer, "end": integer}]
                - Example:
                  [{"id":101,"start":201,"end":203}]
                Instructions:
                1. For each best practice (defined as a unique combination of pillar, question, and best practice), determine the contiguous range of findings it applies to from the {{scanning_tool_title}} Findings.
                2. Use the predefined unique ID from the WAFR question set for the "id" field.
                3. Define "start" as the starting index and "end" as the ending index (inclusive) of the range of findings for that best practice.
                4. Return ONLY the FINAL MINIFIED JSON object. No additional text, comments, or formatting is allowed.
                5. Do not prefix or suffix the output with any extra characters or messages. Any deviation from the exact specified structure will result in a failure of the state machine.
                Inputs:
                - WAFR Pillars, Questions, and Best Practices:
                  {{question_set_data}}
                - {{scanning_tool_title}} Findings:
                  {{scanning_tool_data}}
          InferenceConfiguration:
            Text:
              Temperature: 0
              MaxTokens: 2048
      Tags:
        Project: !Ref Project
        Owner: !Ref Owner
        Name: BedrockPrompt
  StateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub '${ParentStackName}-StateMachine'
      Tags:
        Owner: !Ref Owner
        Project: !Ref Project
        Name: StateMachine
      Policies:
        - Statement:
            - Effect: Allow
              Action: states:StartExecution
              Resource:
                - !Sub 'arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${ParentStackName}-StateMachine'
        - Statement:
            - Effect: Allow
              Action: ecs:RunTask
              Resource:
                - !Sub 'arn:${AWS::Partition}:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/${ParentStackName}-prowler:*'
                - !Sub 'arn:${AWS::Partition}:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/${ParentStackName}-cloud-custodian:*'
                - !Sub 'arn:${AWS::Partition}:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/${ParentStackName}-cloudsploit:*'
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
                - dynamodb:PutItem
              Resource:
                - !Ref DynamoDBArn
        - Statement:
            - Effect: Allow
              Action: iam:PassRole
              Resource:
                - !Ref ECSExecutionRole
                - !Ref ProwlerTaskRole
                - !Ref CloudCustodianTaskRole
                - !Ref CloudSploitTaskRole
        - Statement:
            - Effect: Allow
              Action:
                - events:PutRule
                - events:PutTargets
                - events:DescribeRule
                - events:DeleteRule
                - events:RemoveTargets
              Resource: '*'
        - Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource:
                - !GetAtt PreparePromptsFunction.Arn
                - !GetAtt InvokeLLMFunction.Arn
                - !GetAtt CleanupFunction.Arn
                - !GetAtt PrepareCustodianFunction.Arn
                - !GetAtt ComputeGraphDataFunction.Arn
      Definition:
        Comment: 'State Machine for WAFR Automation Tool'
        QueryLanguage: JSONata
        StartAt: CreateAssessment
        States:
          CreateAssessment:
            Type: Task
            Resource: arn:aws:states:::dynamodb:putItem
            Arguments:
              TableName: !Ref DynamoDBArn
              Item:
                PK:
                  S: '{% $states.input.organization %}'
                SK:
                  S: "{% 'ASSESSMENT#' & $states.input.assessment_id %}"
                id:
                  S: '{% $states.input.assessment_id %}'
                created_by:
                  S: '{% $states.input.created_by %}'
                organization:
                  S: '{% $states.input.organization %}'
                name:
                  S: '{% $states.input.name %}'
                regions:
                  L: '{% $states.input.regions %}'
                role_arn:
                  S: '{% $states.input.role_arn %}'
                workflows:
                  L: '{% $states.input.workflows %}'
                step:
                  S: 'SCANNING_STARTED'
                raw_graph_datas:
                  M: {}
                execution_arn:
                  S: '{% $states.context.Execution.Id %}'
                created_at:
                  S: '{% $states.input.created_at %}'
            Assign:
              assessment_id: '{% $states.input.assessment_id %}'
              organization: '{% $states.input.organization %}'
              regions: '{% $states.input.regions %}'
              role_arn: '{% $states.input.role_arn %}'
              workflows: '{% $states.input.workflows %}'
            Next: ScanningTools
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $states.input.assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
          ScanningTools:
            Type: Parallel
            Branches:
              - StartAt: ProwlerScan
                States:
                  ProwlerScan:
                    Type: Task
                    Resource: arn:aws:states:::ecs:runTask.sync
                    Arguments:
                      LaunchType: FARGATE
                      Cluster: !Ref ECSCluster
                      TaskDefinition: !Ref ProwlerTaskDefinition
                      NetworkConfiguration:
                        AwsvpcConfiguration:
                          Subnets:
                            - !Ref Subnet
                          SecurityGroups:
                            - !Ref SecurityGroup
                          AssignPublicIp: ENABLED
                      Overrides:
                        ContainerOverrides:
                          - Name: prowler-container
                            Environment:
                              - Name: ASSESSMENT_ID
                                Value: '{% $assessment_id %}'
                              - Name: REGIONS
                                Value: "{% $count($regions) > 0 ? '--filter-region ' & $join($regions, ' ') : '' %}"
                              - Name: ROLE_ARN
                                Value: '{% $role_arn %}'
                    End: true
              - StartAt: PrepareCustodian
                States:
                  PrepareCustodian:
                    Type: Task
                    Resource: !GetAtt PrepareCustodianFunction.Arn
                    Next: CloudCustodianScan
                  CloudCustodianScan:
                    Type: Task
                    Resource: arn:aws:states:::ecs:runTask.sync
                    Arguments:
                      LaunchType: FARGATE
                      Cluster: !Ref ECSCluster
                      TaskDefinition: !Ref CloudCustodianTaskDefinition
                      NetworkConfiguration:
                        AwsvpcConfiguration:
                          Subnets:
                            - !Ref Subnet
                          SecurityGroups:
                            - !Ref SecurityGroup
                          AssignPublicIp: ENABLED
                      Overrides:
                        ContainerOverrides:
                          - Name: cloud-custodian-container
                            Environment:
                              - Name: ASSESSMENT_ID
                                Value: '{% $assessment_id %}'
                              - Name: REGIONS
                                Value: "{% $join([$map($regions, function($r) { '--region ' & $r })], ' ') %}"
                              - Name: POLICIES_URI
                                Value: '{% $states.input %}'
                              - Name: ROLE_ARN
                                Value: '{% $role_arn %}'
                    End: true
              - StartAt: CloudSploitScan
                States:
                  CloudSploitScan:
                    Type: Task
                    Resource: arn:aws:states:::ecs:runTask.sync
                    Arguments:
                      LaunchType: FARGATE
                      Cluster: !Ref ECSCluster
                      TaskDefinition: !Ref CloudSploitTaskDefinition
                      NetworkConfiguration:
                        AwsvpcConfiguration:
                          Subnets:
                            - !Ref Subnet
                          SecurityGroups:
                            - !Ref SecurityGroup
                          AssignPublicIp: ENABLED
                      Overrides:
                        ContainerOverrides:
                          - Name: cloudsploit-container
                            Environment:
                              - Name: ASSESSMENT_ID
                                Value: '{% $assessment_id %}'
                              - Name: ROLE_ARN
                                Value: '{% $role_arn %}'
                    End: true
            Next: PreparePromptsUpdateStep
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
          PreparePromptsUpdateStep:
            Type: Task
            Resource: arn:aws:states:::dynamodb:updateItem
            Arguments:
              TableName: !Ref DynamoDBArn
              Key:
                PK:
                  S: '{% $organization %}'
                SK:
                  S: "{% 'ASSESSMENT#' & $assessment_id %}"
              UpdateExpression: SET step = :newStep
              ExpressionAttributeValues:
                ':newStep':
                  S: 'PREPARING_PROMPTS'
            Next: Prepare Prompts
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
          Prepare Prompts:
            Type: Parallel
            Branches:
              - StartAt: Prepare Prowler Prompts
                States:
                  Prepare Prowler Prompts:
                    Type: Task
                    Resource: !GetAtt PreparePromptsFunction.Arn
                    Arguments:
                      assessment_id: '{% $assessment_id %}'
                      organization: '{% $organization %}'
                      scanning_tool: 'prowler'
                      regions: '{% $regions %}'
                      workflows: '{% $workflows %}'
                    End: true
              - StartAt: Prepare Cloud Custodian Prompts
                States:
                  Prepare Cloud Custodian Prompts:
                    Type: Task
                    Resource: !GetAtt PreparePromptsFunction.Arn
                    Arguments:
                      assessment_id: '{% $assessment_id %}'
                      organization: '{% $organization %}'
                      scanning_tool: 'cloud-custodian'
                      regions: '{% $regions %}'
                      workflows: '{% $workflows %}'
                    End: true
              - StartAt: Prepare CloudSploit Prompts
                States:
                  Prepare CloudSploit Prompts:
                    Type: Task
                    Resource: !GetAtt PreparePromptsFunction.Arn
                    Arguments:
                      assessment_id: '{% $assessment_id %}'
                      organization: '{% $organization %}'
                      scanning_tool: 'cloudsploit'
                      regions: '{% $regions %}'
                      workflows: '{% $workflows %}'
                    End: true
            Next: InvokeLLMUpdateStep
            Output: '{% [$spread($states.result)] %}'
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
          InvokeLLMUpdateStep:
            Type: Task
            Resource: arn:aws:states:::dynamodb:updateItem
            Arguments:
              TableName: !Ref DynamoDBArn
              Key:
                PK:
                  S: '{% $organization %}'
                SK:
                  S: "{% 'ASSESSMENT#' & $assessment_id %}"
              UpdateExpression: SET step = :newStep
              ExpressionAttributeValues:
                ':newStep':
                  S: 'INVOKING_LLM'
            Next: PromptMap
            Output: '{% $states.input %}'
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
          PromptMap:
            Type: Map
            MaxConcurrency: 5
            ItemProcessor:
              ProcessorConfig:
                Mode: INLINE
              StartAt: InvokeLLM
              States:
                InvokeLLM:
                  Type: Task
                  Resource: !GetAtt InvokeLLMFunction.Arn
                  Arguments:
                    assessment_id: '{% $assessment_id %}'
                    organization: '{% $organization %}'
                    prompt_uri: '{% $states.input %}'
                    prompt_arn: !GetAtt BedrockPrompt.Arn
                  End: true
                  Retry:
                    - ErrorEquals:
                        - States.TaskFailed
                      BackoffRate: 2
                      IntervalSeconds: 1
                      MaxAttempts: 3
            Next: ComputeGraphData
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
          ComputeGraphData:
            Type: Task
            Resource: !GetAtt ComputeGraphDataFunction.Arn
            Arguments:
              assessmentId: '{% $assessment_id %}'
              organization: '{% $organization %}'
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
            Next: 'FinishUpdateStep'
          FinishUpdateStep:
            Type: Task
            Resource: arn:aws:states:::dynamodb:updateItem
            Arguments:
              TableName: !Ref DynamoDBArn
              Key:
                PK:
                  S: '{% $organization %}'
                SK:
                  S: "{% 'ASSESSMENT#' & $assessment_id %}"
              UpdateExpression: SET step = :newStep
              ExpressionAttributeValues:
                ':newStep':
                  S: 'FINISHED'
            Next: Cleanup
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
          Cleanup:
            Type: Task
            Resource: !GetAtt CleanupFunction.Arn
            Arguments:
              assessment_id: '{% $assessment_id %}'
              organization: '{% $organization %}'
            Catch:
              - ErrorEquals:
                  - States.ALL
                Next: CleanupOnError
                Output:
                  assessment_id: '{% $assessment_id %}'
                  organization: '{% $organization %}'
                  error: '{% $states.errorOutput %}'
            End: true
          CleanupOnError:
            Type: Task
            Resource: !GetAtt CleanupFunction.Arn
            End: true

Outputs:
  StateMachineArn:
    Description: State Machine Arn
    Value: !Ref StateMachine
